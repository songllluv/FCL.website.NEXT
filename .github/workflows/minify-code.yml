name: è‡ªåŠ¨å‹ç¼©ä»£ç å¹¶æ¨é€è‡³minåˆ†æ”¯

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  minify-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: é…ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: å®‰è£…å‹ç¼©å·¥å…·
        run: |
          npm install -g html-minifier-terser@7.2.0 clean-css-cli@5.6.3 terser@5.26.0
          echo "âœ… å‹ç¼©å·¥å…·å®‰è£…å®Œæˆ"

      - name: åˆå§‹åŒ–gité…ç½®
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
      - name: æ£€æŸ¥å¹¶åˆ›å»ºminåˆ†æ”¯ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        run: |
          git fetch origin
          if ! git show-ref --verify --quiet refs/remotes/origin/min; then
            echo "âš ï¸ è¿œç¨‹minåˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºåˆ†æ”¯"
            git checkout --orphan min
            git rm -rf .
            git commit --allow-empty -m "Initial min branch"
            git push origin min
            git checkout main
          fi

      - name: åˆ‡æ¢åˆ°mainåˆ†æ”¯å¹¶ç¡®ä¿æœ€æ–°
        run: |
          git checkout main
          git pull origin main

      - name: è¾“å‡ºå¸®åŠ©
        run: |
          html-minifier-terser --help
          cleancss --help
          terser --help

      - name: åœ¨mainåˆ†æ”¯ä¸Šç”Ÿæˆå‹ç¼©æ–‡ä»¶
        run: |
          # åˆå§‹åŒ–distç›®å½•
          rm -rf dist && mkdir -p dist
          echo "âœ… æ¸…ç†å¹¶é‡å»ºdistç›®å½•å®Œæˆ"
          
          # å¤„ç†æ‰€æœ‰æ–‡ä»¶
          find . -type f \
            ! -path "./node_modules/*" \
            ! -path "./dist/*" \
            ! -path "./.vscode/*" \
            ! -path "./.git/*" | while IFS= read -r file; do
              output="dist/${file#./}"
              mkdir -p "$(dirname "$output")"

              case "$file" in
                *.html)
                  echo "ğŸ”§ å‹ç¼©HTML: $file"
                  html-minifier-terser \
                    --collapse-whitespace \
                    --remove-comments \
                    --remove-script-type-attributes \
                    --remove-style-link-type-attributes \
                    -o "$output" "$file"
                  ;;
                *.css)
                  echo "ğŸ”§ å‹ç¼©CSS: $file"
                  cleancss -O0 -o "$output" "$file"
                  ;;
                *.js)
                  echo "ğŸ”§ å‹ç¼©JS: $file"
                  terser "$file" \
                    -o "$output"
                  ;;
                *.json)
                  echo "ğŸ”§ å‹ç¼©JSON: $file"
                  node -e "
                    const fs = require('fs');
                    try {
                      const data = JSON.parse(fs.readFileSync('$file', 'utf8'));
                      fs.writeFileSync('$output', JSON.stringify(data));
                    } catch (e) {
                      console.error('âŒ JSONè§£æå¤±è´¥:', '$file', e.message);
                      process.exit(1);
                    }
                  "
                  ;;
                *)
                  echo "ğŸ“¤ å¤åˆ¶é™æ€èµ„æº: $file"
                  cp -f "$file" "$output"
                  ;;
              esac
            done
          echo "âœ… æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆ"

      - name: ä¿å­˜distç›®å½•åˆ°ä¸´æ—¶ä½ç½®
        run: |
          cp -rf dist /tmp/
          echo "âœ… distç›®å½•å·²ä¿å­˜åˆ°ä¸´æ—¶ä½ç½®"

      - name: åˆ‡æ¢åˆ°minåˆ†æ”¯å¹¶æ›´æ–°
        run: |
          git checkout -B min origin/min
          git clean -fdx --exclude=.git
          echo "âœ… åˆ‡æ¢åˆ°minåˆ†æ”¯å¹¶æ¸…ç†å®Œæˆ"

      - name: æ¢å¤distç›®å½•å¹¶å¤åˆ¶åˆ°minåˆ†æ”¯
        run: |
          # æ¢å¤distç›®å½•
          cp -rf /tmp/dist .
          echo "âœ… distç›®å½•å·²ä»ä¸´æ—¶ä½ç½®æ¢å¤"
          
          # å¤åˆ¶distç›®å½•å†…å®¹åˆ°minåˆ†æ”¯æ ¹ç›®å½•
          cp -rf dist/* .
          rm -rf dist
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«å¤åˆ¶
          echo "ğŸ“‹ å¤åˆ¶å®Œæˆåçš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la

      - name: æäº¤å¹¶æ¨é€æ›´æ–°
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ— ä»£ç å˜æ›´ï¼Œæ— éœ€æäº¤"
            exit 0
          fi

          commit_msg="[Actions]ä¿®æ”¹ï¼šå‹ç¼©ï¼š$(git log main -1 --pretty=format:'%s (%h)')"
          git commit -m "$commit_msg"
          
          # ä½¿ç”¨--force-with-leaseç¡®ä¿å®‰å…¨æ¨é€
          git push origin min --force-with-lease
          echo "âœ… å‹ç¼©ä»£ç å·²æ¨é€è‡³minåˆ†æ”¯"
